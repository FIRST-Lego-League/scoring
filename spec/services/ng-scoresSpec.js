describe('ng-scores',function() {
    "use strict";
    var ngServices = factory('services/ng-services');
    var module = factory('services/ng-scores',{
        'services/ng-services': ngServices,
        'services/log': logMock,
        'services/ng-message': factory('services/ng-message', {
            'services/ng-services': ngServices
        }),
        'services/ng-independence': factory('services/ng-independence', {
            'services/ng-services': ngServices
        }),
        'services/ng-rankings': factory('services/ng-rankings', {
            'services/ng-services': ngServices,
            'services/ng-groups': factory('services/ng-groups', {
                'services/ng-services': ngServices
            })
        }),
        'services/ng-score': factory('services/ng-score', {
            'services/ng-services': ngServices
        }),
        'services/ng-validation': factory('services/ng-validation', {
            'services/ng-services': ngServices,
            'services/log': logMock
        })
    });

    var $scores;
    var $stages;
    var $teams;
    var $q;
    var dummyTeam =  {
        number: 123,
        name: 'foo'
    };
    var rawMockStage = { id: "test", rounds: 3, name: "Test stage" };
    var rawMockScore = {
        id: 'asd23d',
        file: 'somescore.json',
        teamNumber: 123,
        stageId: "test",
        round: 1,
        score: 150,
        originalScore: 150,
        published: false,
        edited: undefined,
        table: undefined
    };
    var mockStage;
    var mockScore;
    var mockTeam;
    var fsMock;

    beforeEach(function() {
        fsMock = createFsMock({
            "scores.json": { version: 2, scores: [rawMockScore], sheets: [] },
            "stages.json": [rawMockStage],
            "teams.json": [dummyTeam]
        });
        angular.mock.module(module.name);
        angular.mock.module(function($provide) {
            $provide.value('$fs', fsMock);
        });
        angular.mock.inject(["$scores", "$stages", "$teams", "$q", function(_$scores_, _$stages_, _$teams_,_$q_) {
            $scores = _$scores_;
            $stages = _$stages_;
            $teams = _$teams_;
            $q = _$q_;
        }]);

        return $stages.init().then(function() {
            mockStage = $stages.get(rawMockStage.id);
            return $teams.init();
        }).then(function() {
            mockTeam = $teams.get(dummyTeam.number);
            mockScore = {
                file: 'somescore.json',
                team: mockTeam.number,
                stage: mockStage.id,
                round: 1,
                score: 150,
                originalScore: 150
            };
            return $scores.init();
        });
    });

    // Strip autogenerated properties to (hopefully ;)) arrive at the same
    // object as what was used as input to $scores.add().
    function filteredScores() {
        return $scores.scores.map(function(score) {
            return {
                file: score.file,
                team: score.teamNumber,
                stage: score.stageId,
                round: score.round,
                score: score.score,
                originalScore: score.originalScore
            };
        });
    }

    describe('init',function() {
        it('should load mock score initially',function() {
            expect(filteredScores()).toEqual([mockScore]);
        });
    });

    describe('clear',function() {
        it('should clear the scores',function() {
            expect(filteredScores()).toEqual([mockScore]);
            $scores.clear();
            expect(filteredScores()).toEqual([]);
        });
    });

    describe('load',function() {
        it('should load from scores.json',function() {
            return $scores.load().then(function() {
                expect(fsMock.read).toHaveBeenCalledWith('scores.json');
                expect(filteredScores()).toEqual([mockScore]);
            });
        });

        it('should log an error if loading fails',function() {
            fsMock.read.and.returnValue(Q.reject('read err'));
            return $scores.load().then(function() {
                expect(logMock).toHaveBeenCalledWith('scores read error','read err');
            });
        });
    });

});
